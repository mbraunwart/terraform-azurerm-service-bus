<!-- TOC -->
<!-- /TOC -->

# Azure Service Bus Infrastructure Module

## Purpose

This Terraform module deploys an Azure Service Bus namespace with enterprise-grade messaging, auto-forwarding, and automation workflows for streamlined operations and maintenance. It supports queues, topics, and dead-letter handling, along with secure identity management and monitoring features.

### Key Capabilities

- **Premium Service Bus Namespace** with configurable capacity and messaging partitions
- **Comprehensive Queue Management** with configurable message size, TTL, and delivery settings
- **Topic and Subscription Support** for pub/sub messaging patterns
- **Advanced Security Features**
  - Private network access only (public network access disabled)
  - Granular authorization rules (send, listen, manage)
  - SystemAssigned managed identity integration
- **Storage Integration**
  - Dead-letter message archival
  - Session state management
  - Automated container lifecycle management
- **Dead Letter Handling**
  - Dedicated dead-letter queue
  - Automatic message forwarding
  - Configurable retention policies
  - Automated cleanup via Storage lifecycle management
- **Auto-Forwarding** between queues for seamless message routing
- **Azure Automation Integration** for message cleanup and archival
- **Secure Role Assignments** that leverage managed identities for granular access

## Implementation Details

### Core Features

1. **Namespace Configuration**
   - Premium SKU with configurable capacity
   - Private network access enforcement
   - Flexible authorization rules

2. **Message Handling**
   - Configurable message sizes and TTL
   - Session support for ordered message processing
   - Maximum delivery count controls

3. **Storage Integration**
   - Three-container system (service bus, dead letter, session state)
   - Automated blob lifecycle management
   - RBAC-based access control

4. **Monitoring and Diagnostics**
   - Azure Monitor integration
   - Comprehensive logging of all operations
   - Metric collection for performance tracking

### Best Practices

- Implements separate authorization rules for send, listen, and manage operations
- Uses managed identities for secure storage access
- Enforces private network access for enhanced security
- Implements automatic dead-letter message handling
- Provides configurable message retention policies

## Usage Example

```hcl
module "service_bus" {
  source = "github.com/your-org/terraform-azurerm-service-bus"

  resource_group_name = "rg-messaging-prod"
  location            = "westeurope"

  servicebus_namespace = {
    name                          = "sb-messaging-prod"
    sku                          = "Premium"
    capacity                     = 2
    premium_messaging_partitions = 1
    auth_rules = {
      manage = true
      send   = false
      listen = false
    }
  }

  storage_configuration = {
    enabled = true
    storage_account_id = "/subscriptions/.../resourceGroups/storage-rg/providers/Microsoft.Storage/storageAccounts/mystorageaccount"
    containers = {
      service_bus = {
        name        = "service-bus"
        access_type = "private"
      }
      dead_letter = {
        name      = "dead-letter"
        ttl_days  = 30
        access_type = "private"
      }
      session_state = {
        name        = "session-state"
        access_type = "private"
      }
    }
  }
}
```

## Diagnostic Settings

The module automatically configures diagnostic settings to capture all logs and metrics in the specified Log Analytics workspace, enabling comprehensive monitoring and troubleshooting capabilities.

